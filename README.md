
### На оценки 4-5

**Решение отправлено 23 мая, на день позже дедлайна**

1. Выполняющий: **Битюгов Алексей Сергеевич**, **БПИ217**
2. Вариант **20** Задача о магазине – 2 (забывчивые покупатели)

*В магазине работают два отдела, каждый отдел обладает уникальным ассортиментом.*  
*В каждом отделе работает один продавец.*  
*В магазин ходят исключительно забывчивые покупатели, поэтому каждый покупатель носит с собой список товаров, которые желает купить.*  
*Покупатель приобретает товары точно в том порядке, в каком они записаны в его списке.*  
*При этом товары в списке расположены в случайном порядке, что заставляет покупателя переходить от отдела к отделу, если это требуется для совершения покупок.*  
*Продавец может обслужить только одного покупателя за раз.*  
*Покупатель, вставший в очередь, засыпает пока не дойдет до продавца.*  
*Продавец засыпает, если в его отделе нет покупателей, и просыпается, если появится хотя бы один.*  

*Создать приложение, моделирующее работу магазина в течение рабочего дня.*  
*Каждый продавецц — клиент.*  
*Покупатели изначально порождаются отдельным клиентом.*  
*Сервер обеспечивает взаимодействие покупателей и клиентов.*  

3. Используются 4 вида программ:

1) `Сustomer` — клиент; делает запросы к `Server`, пытаясь купить нужный ему товар
2) `Observer` — клиент; делает запросы к `Server`, чтобы получить актуальную статистику
3) `Seller` — клиент; обрабатывает запросы о покупке товара от `Server`
4) `Server` — сервер; отвечает на запросы от `Сustomer` и `Observer`

Для работы всех клиентов требуется работающий сервер  
Для успешной обработки запросов от `Сustomer` должны работать оба `Seller`  
`Сustomer` и `Observer` можно запускать в произвольном количестве  
`Server` работает в 2 потоках — для обработки всех запросов от `Сustomer` и всех от `Observer`  
Потоки циклично обрабатывают по 1 запросу  
`Server` пробует найти товар у обоих `Seller`  

Программы расположены в [исходниках](https://github.com/axhse/OS-HW-3/tree/main/solution) с соответсвующими названиями  

4. Запуск

Тестировалось на WSL  

Для всех программ имеются сетевые настройки по умолчанию:
1) ip-адреса определяются как INADDR_ANY
2) определено 4 порта по умолчанию — для `Сustomer`, для `Observer` и 2 для `Seller`

Опции комадной строки для клиентов:  
 • `--server-ip` — ip-адрес сервера  
 • `--server-port` — порт сервера  
 • `--tempo` — искусственные паузы программ в миллисекнудах, от 1 до 10000  
 • `--id` — целочисленный идентификатор, для `Сustomer` и `Observer`  

 • `--products` — файл со списком покупок, обязательное, для `Сustomer`  
 • `--products` — файл с ассортиментом товаров, обязательное, для `Seller`  
 • `--is-second` — обязательное для второго `Seller`  

Опции для сервера:  
 • `--customer-ip` — ip-адрес для `Customer`  
 • `--seller1-ip` — ip-адрес для первого `Seller`  
 • `--seller2-ip` — ip-адрес для второго `Seller`  
 • `--observer-ip` — ip-адрес для `Observer`  
 • `--customer-port` — порт для `Customer`  
 • `--seller1-port` — порт для первого `Seller`  
 • `--seller2-port` — порт для второго `Seller`  
 • `--observer-port` — порт для `Observer`  

Компиляция всех программ:
```
gcc solution/server.c -o server.out
gcc solution/seller.c -o seller.out
gcc solution/customer.c -o customer.out
gcc solution/observer.c -o observer.out

```

Команды для запуска программ (в разных окнах терминала):
```
./server.out
```
```
./seller.out --products input/products1.txt
```
```
./seller.out --products input/products2.txt --is-second
```
```
./customer.out --products input/order1.txt --id 11111
```
Опционально:
```
./customer.out --products input/order2.txt --id 22222
```
```
./observer.out --id 40004
```
```
./observer.out --id 50005
```

Запуск на localhost с другими портами:
```
./server.out --customer-ip 127.0.0.1 --seller1-ip 127.0.0.1 --seller2-ip 127.0.0.1 --observer-ip 127.0.0.1 --customer-port 17333 --seller1-port 17111 --seller2-port 17222 --observer-port 17444
```
```
./seller.out --products input/products1.txt --server-ip 127.0.0.1 --server-port 17111
```
```
./seller.out --products input/products2.txt --is-second --server-ip 127.0.0.1 --server-port 17222
```
```
./customer.out --products input/order1.txt --id 11111 --server-ip 127.0.0.1 --server-port 17333
```
```
./observer.out --id 40004 --server-ip 127.0.0.1 --server-port 17444
```

7. Примеры работы программ

[Работают 1 Customer и 1 Observer](https://github.com/axhse/OS-HW-3/blob/main/demo/working2.png)  
[Команды для запуска](https://github.com/axhse/OS-HW-3/blob/main/demo/starting.png)  
[Работают 2 Customer и 2 Observer](https://github.com/axhse/OS-HW-3/blob/main/demo/working4.png)  
[Работа на localhost](https://github.com/axhse/OS-HW-3/blob/main/demo/custom%20networking.png)  
[Остановлен Customer](https://github.com/axhse/OS-HW-3/blob/main/demo/customer%20stopped.png)  
Вся программа продолжает работать без ошибок  
[Остановлен Seller](https://github.com/axhse/OS-HW-3/blob/main/demo/seller%20stopped.png)  
`Customer 22222` не получил ответа от сервера и остановился  
`Server` ждет переподключения `Seller 1`  
`Customer 11111` ждет ответа от `Server`  
Запросы `Observer` успешно обрабатываются  
[Остановлен Server](https://github.com/axhse/OS-HW-3/blob/main/demo/server%20stopped.png)  
Все клиенты поняли, что сервер недоступен и остановились  
`Customer` не получили ожидаемого ответа от сервера,  
вывели сообщение об ошибке и также контролируемо остановились  

8. Остановки

Клиенты остановливаются, когда `Server` не доступен или если передача данных с ним оборвалась  
`Server` не останавливается никогда, ожидая новых подключений от всех клиентов  

### На оценку 6-7

Реализована программа `Observer`, которая получает информацию от сервера о количествах выполненных запросов  
и о количестве проданных товаров  

### На оценку 8

Можно запускать несколько `Observer` одновременно  
Запросы от всех `Observer` обрабатываются в отдельном потоке программы `Server`  

### На оценку 9

Все 3 типа клиентов могут подключаться/отключаться во время работы `Server`  
Сервер проверяет случаи, когда обмен данных с клиентом не был успешен  

В случае с отключением `Observer` и `Customer` может оборваться передача данных,  
но сервер всегда перейдет к обработке следующих запросов  
Подключения дополнительных `Observer` и `Customer` не создают ошибок  

В случае с отключением `Seller` может оборваться передача данных  
Из-за этого может остановиться и `Customer`, запрос которого обрабатывался в данный момент  
При этом `Server` всегда переходит к обработке следующего запроса от `Customer`, ожидая перезапуска `Seller`  

### На оценку 10

После принудительной остановки сервера штатно останавливаются все клиенты, понимая, что сервер недоступен  
В этот момент может оборваться передача данных  
